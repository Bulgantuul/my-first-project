# .github/workflows/ci-tests.yml

name: CI/CD Pipeline (Test & Deploy to Heroku) # Workflow-–∏–π–Ω –Ω—ç—Ä–∏–π–≥ ”©”©—Ä—á–∏–ª–ª”©”©

on:
  push:
    # main branch –±–æ–ª–æ–Ω feature branch-—É—É–¥–∞–¥ push —Ö–∏–π—Ö—ç–¥ –∞–∂–∏–ª–ª–∞–Ω–∞.
    branches: [ main, feature/** ] 
  pull_request:
    # Pull Request-–∏–π–≥ main —Ä—É—É –Ω—ç–≥—Ç–≥—ç—Ö—ç—ç—Å ”©–º–Ω”© —à–∞–ª–≥–∞–Ω–∞.
    branches: [ main ]

jobs:
  # ===============================================
  # 1. CI JOB: –¢–µ—Å—Ç“Ø“Ø–¥–∏–π–≥ –ê–∂–∏–ª–ª—É—É–ª–∂, –ö–æ–¥—ã–≥ –ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö
  # ===============================================
  test:
    runs-on: ubuntu-latest 

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v3
        with:
          node-version: '20' 
          
      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies (Use npm ci for CI environments)
        run: npm ci 
        
      - name: Run Unit Tests
        # package.json –¥–æ—Ç–æ—Ä—Ö "test" —Å–∫—Ä–∏–ø—Ç–∏–π–≥ –∞–∂–∏–ª–ª—É—É–ª–Ω–∞.
        run: npm run test
        
  # ===============================================
  # 2. CD JOB: Heroku —Ä—É—É –ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä Deploy –•–∏–π—Ö
  # ===============================================
  deploy:
    # 1. Deploy job –Ω—å test job –∞–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª—Å–æ–Ω “Ø–µ–¥ –ª —ç—Ö—ç–ª–Ω—ç.
    needs: test 
    
    # 2. –ó”©–≤—Ö”©–Ω 'main' branch-–¥ push —Ö–∏–π—Ö—ç–¥ Deploy —Ö–∏–π–Ω—ç.
    if: github.ref == 'refs/heads/main'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Heroku (Continuous Deployment)
        # Heroku-–¥ deploy —Ö–∏–π—Ö—ç–¥ –∞—à–∏–≥–ª–∞–≥–¥–∞—Ö Action
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          # GitHub Secrets —Ö—ç—Å—ç–≥—Ç –æ—Ä—É—É–ª—Å–∞–Ω —Ç“Ø–ª—Ö“Ø“Ø—Ä“Ø“Ø–¥ (HEROKU_API_KEY, HEROKU_APP_NAME)
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }} 
          heroku_email: "—Ç–∞–Ω—ã@–∏–º—ç–π–ª.com" # <--- –≠–Ω–¥ ”®”©—Ä–∏–π–Ω –∏–º—ç–π–ª—ç—ç –∑–∞–∞–≤–∞–ª —Å–æ–ª–∏–Ω–æ!
          justlogin: true
          
      - name: Deployment Success Notification
        run: echo "üéâ –¢”©—Å”©–ª Production –æ—Ä—á–∏–Ω–¥ –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö“Ø—Ä–≥—ç–≥–¥–ª—ç—ç!"